#!/bin/env ruby
# frozen_string_literal: true

require "json"
require "yaml"
require_relative "../../common/lib/util"
require_relative "../lib/common"

$configure_hash = JSON.parse($stdin.read)

container_image = $configure_hash["container_image"]
gcp_creds_gcr_b64 = $configure_hash["gcp_creds_gcr_b64"]

configure_gcr(gcp_creds_gcr_b64, container_image)
map = YAML.load_file $compose_file
map["services"]["postgresql"]["image"] = container_image

File.open($compose_file, "w") { |f| YAML.dump(map, f) }

run_database(container_image)
