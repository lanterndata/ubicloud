#!/bin/env ruby
# frozen_string_literal: true

require "json"
require 'yaml'
require_relative "../../common/lib/util"
require_relative "./common"

$configure_hash = JSON.parse($stdin.read)


pg_version = r"#{$pg_mount_path}/bin/pg_config --version | sed -rn 's/PostgreSQL (.*)\..*/\1/p' | tr -d '\n'"
unless pg_version
 raise "Could not detect Postgres Version"
end

version = configure_hash["version"]

r "cd /tmp"
r "rm -rf lantern-extras* || true"
r "wget https://github.com/lanterndata/lantern_extras/releases/download/#{version}/lantern-extras-#{version}.tar -O lantern-extras.tar"
r "tar xf lantern-extras.tar"
r "cd lantern-extras-#{version}"
r "PG_CONFIG=#{pg_mount_path}/bin/pg_config make install"
r "rm -rf /tmp/lantern-extras*"

update_extensions_in_sql
